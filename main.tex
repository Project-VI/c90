\documentclass[9pt,b5paper,tombo,openany]{jsbook}

\usepackage[dvipdfmx]{graphicx}
\usepackage{listings}
\usepackage{inconsolata}
\usepackage{url}

\lstset{basicstyle={\footnotesize\ttfamily}}

\setlength{\textwidth}{\fullwidth}
\setlength{\evensidemargin}{\oddsidemargin}

\begin{document}

\tableofcontents

\chapter{はじめに}

\setcounter{page}{1}

\chapter{OpenStackアップグレード超入門}
本章は、 Qiita に投稿した OpenStack Advent Calendar 2015 の 12 月 3 日の記事である「 OpenStack をアップグレードしたら心臓止まりかけた話」という物語を改めて書き記した章である(ただし、改訂版というわけではない)。

本章で行ったアップグレード作業は実話なのだが、作業自体は 2015 年 11 月時点での出来事である。その後、 Liberty リリースは幾度かのポイントリリースを経ているので、その中で今回遭遇した事象はもしかしたら解消されているかもしれない。が、我々には同じことをもう一度行う体力は残っていない。よって、 Liberty リリースを使ってこれからアップグレードを検討するという奇特なエンジニアの皆々様は、是非元記事であるQiita記事のコメント欄にその結果をご報告いただきたい。

\section{はじめに}
先日、 OpenStack 環境を Juno から Liberty に一気にアップグレードしてみた。なんでそんなことしたのかっていうと、先日の OpenStack Summit Tokyo で PayPal が Folsom から Kilo までアップグレードしたっていうセッション見たら、自分にもできるって思ったからだ。

いや、結果、アップグレードできたんだけどさ。まぁそんなわけで、見事に人柱になれたと思うので、ここではその時のことを記すことにした。

\noindent
なお、そんな PayPal 様のセッションはこちら。

\begin{quote}
PayPal's Cloud Journey From Folsom to Kilo -- What We Learned in the Upgrade
\end{quote}

なお、アップグレード前の構成は、 OS が Ubuntu 14.04 、 OpenStack のバージョンが Juno 、 Hypervisor が KVM 、 Neutron Driver が VLAN + OVS で L3 Agent は稼働させていない構成となる。

\section{アップグレード}
Keystone、 Glance、 Nova、 Neutron の順番でやるのが一般的なんじゃないだろうか。 Design Summit では、各コンポーネントでバージョンがバラバラだって言う企業もいたから、順番は参考程度なんだが、全コンポーネントをアップグレードするならこの順番がいいと思う。ちなみに、無停止アップグレードは絶対無理だからアキラメロン。って、 Design Summit に居たハッカーのおっちゃんたちが言っとりました。おっしゃる通りでございます。

\noindent
{\bf . . . 閑話休題 . . . }

\subsection{ロードバランサの紐付け解除}
Keystoneのフロントにあるロードバランサの5000番ポートに対する紐付けを解除し、完全に外部からの通信を止める。35357番ポートはそのままで問題ないと思われる。

\subsection{Liberty リポジトリ導入}
まずは、全てのサーバにLibertyリリースのリポジトリを入れよう。

\begin{lstlisting}
  $ sudo echo "deb http://ubuntu-cloud.archive.canonical.com/ubuntu \
    trusty-updates/liberty main" \
    > /etc/apt/sources.list.d/cloudarchive-liberty.list
  $ sudo apt-get update
\end{lstlisting}

\subsection{Keystone 前準備}
KeystoneのDBに溜まっているtokenを削除する。LibertyからはデフォルトでMemcachedをtoken用途で利用するようになっているので、そちらを使うことにした。つまり、事前にMemcached用サーバを用意する必要がある。

\begin{lstlisting}
  $ sudo su -s /bin/sh -c "keystone-manage token_flush" keystone
\end{lstlisting}

\noindent
DBのTokenを綺麗に消したら次は定期実行していたCronを停止する。

\begin{lstlisting}
  $ sudo crontab -e -u keystone
\end{lstlisting}

\noindent
以下の行を削除する。

\begin{lstlisting}
  @hourly /usr/bin/keystone-manage token_flush > \
  /var/log/keystone/keystone-tokenflush.log 2>&1
\end{lstlisting}

\noindent
潔く、Keystoneを止めましょう。

\begin{lstlisting}
  $ sudo service keystone stop
\end{lstlisting}

\subsection{データベースのバックアップ}
DBサーバにログインして以下のコマンドでDBのバックアップを取得する。

\begin{lstlisting}
  $ sudo mysqldump -uroot -p --opt --add-drop-database \
    --single-transaction --master-data=2 keystone > \
    liberty-keytone-db-backup.sql
  $ sudo mysqldump -uroot -p --opt --add-drop-database \
    --single-transaction --master-data=2 glance > \
    liberty-glance-db-backup.sql
  $ sudo mysqldump -uroot -p --opt --add-drop-database \
    --single-transaction --master-data=2 nova > \
    liberty-nova-db-backup.sql
  $ sudo mysqldump -uroot -p --opt --add-drop-database \
    --single-transaction --master-data=2 neutron > \
    liberty-neutron-db-backup.sql
\end{lstlisting}

\subsection{Keystone アップグレード}
ここでKeystoneのアップグレードを行う。いろんなパラメータが新規に追加されたり廃止予定になったりしているが、それについては書ききれないのでConfiguration Referenceを参照してほしい。アップグレード自体は、apt-get install XXXXして、その後、keystone.confを書き換えて、プロセスを起動するだけである。基本的にはインストール手順のとおりに行えば問題ない(はず)。

ちなみに、confにDEBUGオプションを入れていると、プロセス起動直後のログに、confの各項目に何の値が設定されているのかが全て出力される。親切なことに、廃止予定の項目も指摘してくれる。これは全コンポーネント共通の仕組みなので、覚えておいて損はない。そういえば、Novaのusernameという項目で、usernameは廃止予定だから使うのやめてuser-nameを使えってログに出ていたから、使うのやめてuser-name使ったらエラー吐きまくってNovaが動かなくなった。ツンデレか。話が逸れた。

keystone.confを配置したら以下のコマンドでLibertyリリースまでDBのスキーマのマイグレーションを行う。Kilo以降、KeystoneはApacheで稼働するようになったので、事前にKeystoneプロセスが止まっていることを確認してApacheを起動しておこう。

\begin{lstlisting}
  $ sudo service keystone stop
  $ sudo service apache2 restart
  $ sudo su -s /bin/sh -c "keystone-manage db_sync" keystone
\end{lstlisting}

エラーが出なければKeystoneのアップグレードは完了である。一応、openstackコマンドが実行可能かどうかを確認しておこう。

\begin{lstlisting}
  $ ADMIN_TOKEN=${keystone.confに記載されているadmin_tokenの文字列}
  $ export OS_TOKEN=${ADMIN_TOKEN}
  $ export OS_URL=http://${Keystoneが稼働しているどれかのサーバのIPアドレス}:35357/v3
  $ export OS_IDENTITY_API_VERSION=3
  $ openstack service list
\end{lstlisting}

\subsection{Glance アップグレード}
Keystone同様にConfiguration Referenceや公式のインストールガイドを確認しながら、環境にあったglance-api.conf、glance-registry.confを配置しよう。その後、Glanceのdb syncを行う。

\begin{lstlisting}
  $ sudo service glance-api restart
  $ sudo service glance-registry restart
  $ sudo su -s /bin/sh -c "glance-manage db_sync" glance
\end{lstlisting}

\noindent
エラーが出なければGlanceのアップグレードは完了である。

\subsection{nova-api アップグレード (Nova db sync 失敗編)}
最大の難関である。NovaのDBを上手くLibertyまでマイグレーション出来ればアップグレードできたも同然である。がしかし、現実はそうそう上手くはいかなかった。なので、この項ではアップグレードが上手くいかなかった時の状況をそのまま記すことにした。

\subsubsection{まずは一気に Liberty までアップグレードしてみる}
\subsubsection{奇妙な nova-manage のオプション}
\subsubsection{apt 壊れた}

\subsection{nova-api アップグレード (Nova db sync 成功編)}
\subsection{neutron-server アップグレード}
\subsection{Nova / Neutron の残りのパッケージのアップグレード}
\subsection{ロードバランサの紐付け}
\subsection{Horizon アップグレード}
\subsubsection{deb パッケージの謎}
\subsection{アップグレードの終わり}

\section{その後の話}
\subsection{RFC3442 (クラスレス静的ルート) 問題}

\section{アップグレード作業から得た教訓}

\chapter{あとがき}

\thispagestyle{empty}
\vspace*{\stretch{1}}
\begin{flushright}
\begin{minipage}{0.5\hsize}
\begin{description}
  \item{著者：}こじろー・まっきー・謎の少女A
  \item{発行：}2016年8月14日
  \item{印刷：}POPLS (\verb|http://www.inv.co.jp/~popls/|)
\end{description}
\end{minipage}
\end{flushright}

\end{document}
